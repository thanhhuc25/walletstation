<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Wallet station</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles/app.css" />
    <!--<script src="http://localhost:35729/livereload.js"></script>-->

    <script src="js/qrcode-page.min.js"></script>

</head>
<body>
    <div class="input_page qr-code-page">
        <header class="header">
            <div class="header__back header__back--left">
                <a class="header__back__a" href="input.html">
                    <svg width="19px" height="19px" viewBox="0 0 19 19" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                        <desc>Created with Sketch.</desc>
                        <defs></defs>
                        <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g id="暗証番号" transform="translate(-18.000000, -45.000000)" fill="#FFFFFF">
                                <g id="Group-3">
                                    <g id="upper_bar" transform="translate(18.000000, 44.000000)">
                                        <polygon id="back_ico" points="9 19.5 10.5 17.9 4.5 11.6 18.5 11.6 18.5 9.4 4.5 9.4 10.5 3.1 9 1.5 0.5 10.5"></polygon>
                                    </g>
                                </g>
                            </g>
                        </g>
                    </svg>
                    お支払いコード
                </a>
            </div>
            <div class="header__back--right">

                <svg width="26px" height="20px" viewBox="0 0 26 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <!-- Generator: Sketch 51.3 (57544) - http://www.bohemiancoding.com/sketch -->
                    <desc>Created with Sketch.</desc>
                    <defs></defs>
                    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                        <g id="QR画面" transform="translate(-314.000000, -43.000000)" fill="#FFFFFF" fill-rule="nonzero">
                            <g id="カメラのアイコン素材-6" transform="translate(314.000000, 43.000000)">
                                <g id="Group-2">
                                    <g id="Group">
                                        <path d="M12.8571429,8.52459016 C11.134008,8.52459016 9.73860182,9.94346455 9.73860182,11.6939891 C9.73860182,13.4445136 11.1340581,14.863388 12.8571429,14.863388 C14.5802276,14.863388 15.9756839,13.4445136 15.9756839,11.6939891 C15.9756839,9.94346455 14.5802778,8.52459016 12.8571429,8.52459016 Z" id="Shape"></path>
                                        <path d="M24.0452144,3.96062478 L21.1008727,3.96062478 C20.4440522,3.96062478 19.8484037,3.5713927 19.579257,2.96715383 L18.6979885,0.992717593 C18.4288418,0.389232083 17.83244,0 17.1755693,0 L8.53876668,0 C7.8819462,0 7.28554436,0.389232083 7.01559406,0.992717593 L6.13512917,2.96715383 C5.86593222,3.5713927 5.27033395,3.96062478 4.61346325,3.96062478 L1.66912156,3.96062478 C0.747071772,3.96062478 0,4.71478077 0,5.64391542 L0,18.3167094 C0,19.245844 0.747071772,20 1.66912156,20 L13.9361656,20 L24.0451642,20 C24.9664606,20 25.7142857,19.245844 25.7142857,18.3167094 L25.7142857,5.64391542 C25.7143359,4.71478077 24.9664606,3.96062478 24.0452144,3.96062478 Z M12.857168,17.4252423 C9.65854565,17.4252423 7.06657072,14.8104565 7.06657072,11.5844006 C7.06657072,8.35834463 9.65859587,5.74275526 12.857168,5.74275526 C16.0557401,5.74275526 18.6477652,8.35829441 18.6477652,11.5844006 C18.6477652,14.8105068 16.0557903,17.4252423 12.857168,17.4252423 Z" id="Shape"></path>
                                    </g>
                                </g>
                            </g>
                        </g>
                    </g>
                </svg>
            </div>
            

        </header>
        <main class="main">
            <div class="input_page__center_text">
                このコードをレジで提示してください
            </div>
            <div class="qr-code-page__content">
                <a id="qr-code" href="javascript:void(0)" class="qr-code-page__content__barcode">
                    <div id="loader" class="spinner">
                        <div class="bounce1"></div>
                        <div class="bounce2"></div>
                        <div class="bounce3"></div>
                    </div>
                    <div id="barcode128">
                        <svg id="barcode-image"></svg>
                    </div>

                    <!--<div class="qr-code-page__content__barcode__text">-->
                        <!--1234 5678 901234-->
                    <!--</div>-->
                    <div >
                        <div id="qrcode" style="width:128px; height:128px;"></div>
                    </div>
                    <div class="qr-code-page__content__barcode__bottom">
                        <span>

                            <svg width="19px" height="17px" viewBox="0 0 19 17" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                                <!-- Generator: Sketch 51.3 (57544) - http://www.bohemiancoding.com/sketch -->
                                <desc>Created with Sketch.</desc>
                                <defs></defs>
                                <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <g id="QR画面" transform="translate(-30.000000, -472.000000)" fill="#000000">
                                        <path d="M40.521,472 C36.12,472 32.542,475.526 32.433,479.916 L30,479.916 L33.642,483.976 L37.284,479.916 L34.457,479.916 C34.564,476.647 37.237,474.03 40.521,474.03 C43.874,474.03 46.591,476.756 46.591,480.119 C46.591,483.482 43.873,486.208 40.521,486.208 C39.177,486.208 37.935,485.769 36.929,485.027 L35.537,486.516 C36.911,487.595 38.641,488.238 40.52,488.238 C44.99,488.238 48.614,484.603 48.614,480.119 C48.615,475.635 44.991,472 40.521,472 L40.521,472 Z" id="Shape"></path>
                                    </g>
                                </g>
                            </svg>
                        </span>
                        <span>1:10</span>
                    </div>
                </a>
                <div class="qr-code-page__content__bottom">
                    <div class="qr-code-page__content__bottom__left">
                        <span>

<svg width="18px" height="18px" viewBox="0 0 18 18" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 51.3 (57544) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="QR画面" transform="translate(-30.000000, -524.000000)" fill="#000000" fill-rule="nonzero">
            <g id="白抜きのポイントアイコン" transform="translate(30.000000, 524.000000)">
                <path d="M9,0 C4.02978516,0 0,4.02978516 0,9 C0,13.9707773 4.02978516,18 9,18 C13.9702148,18 18,13.9707773 18,9 C18,4.02978516 13.9702148,0 9,0 Z M9.28233984,10.7863945 L8.04142969,10.7863945 L8.04142969,12.6057305 C8.04142969,12.9551133 7.75796484,13.238543 7.40805469,13.238543 L7.09055859,13.238543 C6.74008594,13.238543 6.45718359,12.9550781 6.45718359,12.6057305 L6.45718359,6.14355469 C6.45718359,5.79417188 6.74008594,5.51074219 7.09055859,5.51074219 L9.28233984,5.51074219 C10.9423828,5.51074219 12.2925937,6.69396094 12.2925937,8.14855078 C12.2925937,9.60314063 10.9423828,10.7863945 9.28233984,10.7863945 Z" id="Shape"></path>
            </g>
        </g>
    </g>
</svg>
                        </span>
                        <span>1,000pt</span>
                    </div>
                    <div class="qr-code-page__content__bottom__right">
                        <a href="/index.html">
                            使用しない
                        </a>
                    </div>
                </div>

            </div>
        </main>
    </div>
    <!-- modal-->
    <div id="modal-success" class="modal modal-success">
        <div class="modal-content">
            <div class="modal-content__top">
                <span>
                    <img src="styles/images/wallet2.png">
                </span>
                <span class="modal-content__top__text">
                    お支払い完了
                </span>
            </div>
            <div class="modal-content__text1">
                大楠亭
            </div>
            <div class="modal-content__text2">
                2018/10/3（水） 15:00
            </div>
            <div class="modal-content__text3">
                ¥<span id="total">5,000</span>
            </div>
            <div class="modal-content__bottom">
                <a href="/index.html">OK</a>
            </div>
        </div>

    </div>
<script>

</script>
<script>
    window.COUNT = 0;
    function checkStatus(transaction_token) {
        fetch("/get_status.php?transaction_token="+ transaction_token, {
            method: "POST",
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'transaction_token='+ transaction_token
        }).then(function (value) {
            return value.json();
        })
        .then(function (value) {
            if(value.transaction_status_code && value.transaction_status_code=="success"){
                document.getElementById("total").innerText = value.purchase_price_amount;
                document.getElementById("modal-success").style.display = "block";
            } else{
                // if(window.COUNT < 2){
                //     window.COUNT++;
                //     setTimeout(function () {
                //         checkStatus(transaction_token);
                //     }, 3000);
                // }else{
                //     //@todo : for demo only
                //     document.getElementById("total").innerText = "5,000";
                //     document.getElementById("modal-success").style.display = "block";
                // }
                setTimeout(function () {
                    checkStatus(transaction_token);
                }, 3000);
            }
        })
        .catch(function(err){
            alert((err));
        });
    }

    function generateQRBarCode() {
        fetch("/method_list.php", {
        }).then(function (value) {
            return value.json();
        })
        .then(function (value) {
            if(value.prepaids && value.prepaids.length > 0 || value.default_payment_method_id){
                var method = value.prepaids.length > 0 ? value.prepaids[0] : { payment_method_id: value.default_payment_method_id};
                var method_id = method.payment_method_id;

                fetch("/create_token.php?payment_method_id="+ method_id, {
                    method: "POST",
                     headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'payment_method_id=' + method_id
                }).then(function (data) {
                    return data.json();
                })
                .then(function (data) {
                    if(data.transaction_token){
                        var transaction_token = data.transaction_token;
                        JsBarcode("#barcode-image",transaction_token, {
                        });
                        var qrcode = new QRCode("qrcode", {
                            text: transaction_token,
                            width: 128,
                            height: 128,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                        document.getElementById("loader").style.display = "none";
                        checkStatus(transaction_token);
                    }
                })
                .catch(function(err){
                    alert((err));
                })
            }
        })
        .catch(function(err){
            alert((err));
        });
    }
    generateQRBarCode();
</script>
    <link rel="stylesheet" href="styles/font.css" />
</body>
</html>