<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Wallet station</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles/app.css" />
    <!--<script src="http://localhost:35729/livereload.js"></script>-->

    <script src="js/qrcode-page.min.js"></script>

</head>
<body>
    <div class="input_page qr-code-page">
        <header class="header">
            <div class="header__back header__back--left">
                <a class="header__back__a" href="input.html">
                    <img src="styles/images/back_ico.png">
                    お支払いコード
                </a>
            </div>
            <div class="header__back--right">
                <img src="styles/images/photo.png">
            </div>
            

        </header>
        <main class="main">
            <div class="input_page__center_text">
                このコードをレジで提示してください
            </div>
            <div class="qr-code-page__content">
                <a id="qr-code" href="javascript:void(0)" class="qr-code-page__content__barcode">
                    <div id="loader" class="spinner">
                        <div class="bounce1"></div>
                        <div class="bounce2"></div>
                        <div class="bounce3"></div>
                    </div>
                    <div id="barcode128">
                        <svg id="barcode-image"></svg>
                    </div>

                    <!--<div class="qr-code-page__content__barcode__text">-->
                        <!--1234 5678 901234-->
                    <!--</div>-->
                    <div >
                        <div id="qrcode" style="width:128px; height:128px;"></div>
                    </div>
                    <div class="qr-code-page__content__barcode__bottom">
                        <span>
                            <img src="styles/images/circle.png">
                        </span>
                        <span>1:10</span>
                    </div>
                </a>
                <div class="qr-code-page__content__bottom">
                    <div class="qr-code-page__content__bottom__left">
                        <span>
                            <img src="styles/images/p.png">
                        </span>
                        <span>1,000pt</span>
                    </div>
                    <div class="qr-code-page__content__bottom__right">
                        <a href="/index.html">
                            使用しない
                        </a>
                    </div>
                </div>

            </div>
        </main>
    </div>
    <!-- modal-->
    <div id="modal-success" class="modal modal-success">
        <div class="modal-content">
            <div class="modal-content__top">
                <span>
                    <img src="styles/images/wallet2.png">
                </span>
                <span class="modal-content__top__text">
                    お支払い完了
                </span>
            </div>
            <div class="modal-content__text1">
                大楠亭
            </div>
            <div class="modal-content__text2">
                2018/08/20 (金)　12:30
            </div>
            <div class="modal-content__text3">
                ¥<span id="total">5,000</span>
            </div>
            <div class="modal-content__bottom">
                <a href="/index.html">OK</a>
            </div>
        </div>

    </div>
<script>

</script>
<script>
    window.COUNT = 0;
    function checkStatus(transaction_token) {
        fetch("/get_status.php?transaction_token="+ transaction_token, {
            method: "POST",
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'transaction_token='+ transaction_token
        }).then(function (value) {
            return value.json();
        })
        .then(function (value) {
            if(value.transaction_status_code && value.transaction_status_code=="success"){
                document.getElementById("total").innerText = value.purchase_price_amount;
                document.getElementById("modal-success").style.display = "block";
            } else{
                // if(window.COUNT < 2){
                //     window.COUNT++;
                //     setTimeout(function () {
                //         checkStatus(transaction_token);
                //     }, 3000);
                // }else{
                //     //@todo : for demo only
                //     document.getElementById("total").innerText = "5,000";
                //     document.getElementById("modal-success").style.display = "block";
                // }
                setTimeout(function () {
                    checkStatus(transaction_token);
                }, 3000);
            }
        })
        .catch(function(err){
            alert((err));
        });
    }

    function generateQRBarCode() {
        fetch("/method_list.php", {
        }).then(function (value) {
            return value.json();
        })
        .then(function (value) {
            if(value.prepaids && value.prepaids.length > 0 || value.default_payment_method_id){
                var method = value.prepaids.length > 0 ? value.prepaids[0] : { payment_method_id: value.default_payment_method_id};
                var method_id = method.payment_method_id;

                fetch("/create_token.php?payment_method_id="+ method_id, {
                    method: "POST",
                     headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'payment_method_id=' + method_id
                }).then(function (data) {
                    return data.json();
                })
                .then(function (data) {
                    if(data.transaction_token){
                        var transaction_token = data.transaction_token;
                        JsBarcode("#barcode-image",transaction_token, {
                        });
                        var qrcode = new QRCode("qrcode", {
                            text: transaction_token,
                            width: 128,
                            height: 128,
                            colorDark : "#000000",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                        document.getElementById("loader").style.display = "none";
                        checkStatus(transaction_token);
                    }
                })
                .catch(function(err){
                    alert((err));
                })
            }
        })
        .catch(function(err){
            alert((err));
        });
    }
    generateQRBarCode();
</script>
</body>
</html>